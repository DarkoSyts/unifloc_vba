'=======================================================================================
'Unifloc 7.6  Vulpes zerda                                      khabibullin.ra@gubkin.ru
'Petroleum engineering calculations modules (macroses)
'2000 - 2019
'
'=======================================================================================
' базовые функции для проведения расчетов из интерфейса Excel
Option Explicit
Public Function StartLog()
End Function
Private Function readPVT(Optional ByVal gamma_gas As Double = const_gamma_gas_default, _
                    Optional ByVal gamma_oil As Double = const_gamma_oil_default, _
                    Optional ByVal gamma_wat As Double = const_gamma_wat_default, _
                    Optional ByVal rsb_m3m3 = const_Rsb_default, _
                    Optional ByVal Rp_m3m3 = -1, _
                    Optional ByVal Pb_atma = -1, _
                    Optional ByVal Tres_C = const_Tres_default, _
                    Optional ByVal Bob_m3m3 = -1, _
                    Optional ByVal Muob_cP = -1, _
                    Optional ByVal PVTcorr = StandingBased, _
                    Optional ByVal Ksep_fr = 0, _
                    Optional ByVal PKsep_atma = -1, _
                    Optional ByVal TKsep_C = -1, _
                    Optional ByVal PVTStr As String = "" _
                    ) As CPVT
    Dim PVT As CPVT
    If PVTStr <> "" Then
        Set PVT = PVT_Decode_string(PVTStr)
    Else
        Set PVT = New CPVT
        PVT.Init gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Pb_atma, Bob_m3m3, PVTcorr, Tres_C, Rp_m3m3, Muob_cP
        If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
            Call PVT.ModAfterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
        End If
    End If
    Set readPVT = PVT
End Function
' функция расчета объемного коэффициента газа
Public Function PVT_Bg_m3m3(P_atma, t_c, _
                    Optional ByVal gamma_gas As Double = const_gamma_gas_default, _
                    Optional ByVal gamma_oil As Double = const_gamma_oil_default, _
                    Optional ByVal gamma_wat As Double = const_gamma_wat_default, _
                    Optional ByVal rsb_m3m3 = const_Rsb_default, _
                    Optional ByVal Rp_m3m3 = -1, _
                    Optional ByVal Pb_atma = -1, _
                    Optional ByVal Tres_C = const_Tres_default, _
                    Optional ByVal Bob_m3m3 = -1, _
                    Optional ByVal Muob_cP = -1, _
                    Optional ByVal PVTcorr = StandingBased, _
                    Optional ByVal Ksep_fr = 0, _
                    Optional ByVal PKsep_atma = -1, _
                    Optional ByVal TKsep_C = -1, _
                    Optional ByVal PVTStr As String = "" _
                    ) As Double
' обязательные аргументы функции
' P_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед Rsb если Rp < Rsb
' Pb_atma   Давление насыщения при  температуре Tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' Возвращает значение объемного коэффициента газа, м3/м3
' для заданных термобарических условий.
' В основе расчета корреляция для z факотора
On Error GoTo err1:
    Dim PVT As CPVT
    Set PVT = readPVT(gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Rp_m3m3, Pb_atma, Tres_C, Bob_m3m3, _
                    Muob_cP, PVTcorr, Ksep_fr, PKsep_atma, TKsep_C, PVTStr)
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(t_c))
    PVT_Bg_m3m3 = PVT.Bg_m3m3
    Exit Function
err1:
    PVT_Bg_m3m3 = "error"
    addLogMsg "error in function : PVT_Bg_m3m3"
End Function
' расчет объемного коэффициента нефти
Public Function PVT_Bo_m3m3(P_atma, t_c, _
                    Optional ByVal gamma_gas As Double = const_gamma_gas_default, _
                    Optional ByVal gamma_oil As Double = const_gamma_oil_default, _
                    Optional ByVal gamma_wat As Double = const_gamma_wat_default, _
                    Optional ByVal rsb_m3m3 = const_Rsb_default, _
                    Optional ByVal Rp_m3m3 = -1, _
                    Optional ByVal Pb_atma = -1, _
                    Optional ByVal Tres_C = const_Tres_default, _
                    Optional ByVal Bob_m3m3 = -1, _
                    Optional ByVal Muob_cP = -1, _
                    Optional ByVal PVTcorr = StandingBased, _
                    Optional ByVal Ksep_fr = 0, _
                    Optional ByVal PKsep_atma = -1, _
                    Optional ByVal TKsep_C = -1, _
                    Optional ByVal PVTStr As String = "" _
                    ) As Double
' обязательные аргументы функции
' P_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед Rsb если Rp < Rsb
' Pb_atma   Давление насыщения при  температуре Tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' выходное значение - число
' Возвращает значение объемного коэффициента нефти, м3/м3
' для заданных термобарических условий.
' В основе расчета корреляции PVT
On Error GoTo err1:
    Dim PVT As CPVT
    Set PVT = readPVT(gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Rp_m3m3, Pb_atma, Tres_C, Bob_m3m3, _
                    Muob_cP, PVTcorr, Ksep_fr, PKsep_atma, TKsep_C, PVTStr)
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(t_c))
    PVT_Bo_m3m3 = PVT.Bo_m3m3
    Exit Function
err1:
    PVT_Bo_m3m3 = "error"
    addLogMsg "error in function : PVT_Bo_m3m3"
End Function
' расчет объемного коэффициента воды
Public Function PVT_Bw_m3m3(P_atma, t_c, _
                    Optional ByVal gamma_gas As Double = const_gamma_gas_default, _
                    Optional ByVal gamma_oil As Double = const_gamma_oil_default, _
                    Optional ByVal gamma_wat As Double = const_gamma_wat_default, _
                    Optional ByVal rsb_m3m3 = const_Rsb_default, _
                    Optional ByVal Rp_m3m3 = -1, _
                    Optional ByVal Pb_atma = -1, _
                    Optional ByVal Tres_C = const_Tres_default, _
                    Optional ByVal Bob_m3m3 = -1, _
                    Optional ByVal Muob_cP = -1, _
                    Optional ByVal PVTcorr = StandingBased, _
                    Optional ByVal Ksep_fr = 0, _
                    Optional ByVal PKsep_atma = -1, _
                    Optional ByVal TKsep_C = -1, _
                    Optional ByVal PVTStr As String = "" _
                    ) As Double
' обязательные аргументы функции
' P_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед Rsb если Rp < Rsb
' Pb_atma   Давление насыщения при  температуре Tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' выходное значение - число
' Возвращает значение объемного коэффициента воды, м3/м3
' для заданных термобарических условий.
On Error GoTo err1:
    Dim PVT As CPVT
    Set PVT = readPVT(gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Rp_m3m3, Pb_atma, Tres_C, Bob_m3m3, _
                    Muob_cP, PVTcorr, Ksep_fr, PKsep_atma, TKsep_C, PVTStr)
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(t_c))
    PVT_Bw_m3m3 = PVT.Bw_m3m3
    Exit Function
err1:
    PVT_Bw_m3m3 = "error"
    addLogMsg "error in function : PVT_Bw_m3m3"
End Function
' расчет объемного коэффициента воды
Public Function PVT_Sal_ppm(P_atma, t_c, _
                    Optional ByVal gamma_gas As Double = const_gamma_gas_default, _
                    Optional ByVal gamma_oil As Double = const_gamma_oil_default, _
                    Optional ByVal gamma_wat As Double = const_gamma_wat_default, _
                    Optional ByVal rsb_m3m3 = const_Rsb_default, _
                    Optional ByVal Rp_m3m3 = -1, _
                    Optional ByVal Pb_atma = -1, _
                    Optional ByVal Tres_C = const_Tres_default, _
                    Optional ByVal Bob_m3m3 = -1, _
                    Optional ByVal Muob_cP = -1, _
                    Optional ByVal PVTcorr = StandingBased, _
                    Optional ByVal Ksep_fr = 0, _
                    Optional ByVal PKsep_atma = -1, _
                    Optional ByVal TKsep_C = -1, _
                    Optional ByVal PVTStr As String = "" _
                    ) As Double
' обязательные аргументы функции
' P_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед Rsb если Rp < Rsb
' Pb_atma   Давление насыщения при  температуре Tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' выходное значение - число
' Возвращает соленость воды, ppm
' для заданных термобарических условий.
On Error GoTo err1:
    Dim PVT As CPVT
    Set PVT = readPVT(gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Rp_m3m3, Pb_atma, Tres_C, Bob_m3m3, _
                    Muob_cP, PVTcorr, Ksep_fr, PKsep_atma, TKsep_C, PVTStr)
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(t_c))
    PVT_Sal_ppm = PVT.Sal_ppm
    Exit Function
err1:
    PVT_Sal_ppm = "error"
    addLogMsg "error in function : PVT_Sal_ppm"
End Function
' расчет вязкости нефти
Public Function PVT_Muo_cP(P_atma, t_c, _
                    Optional ByVal gamma_gas As Double = const_gamma_gas_default, _
                    Optional ByVal gamma_oil As Double = const_gamma_oil_default, _
                    Optional ByVal gamma_wat As Double = const_gamma_wat_default, _
                    Optional ByVal rsb_m3m3 = const_Rsb_default, _
                    Optional ByVal Rp_m3m3 = -1, _
                    Optional ByVal Pb_atma = -1, _
                    Optional ByVal Tres_C = const_Tres_default, _
                    Optional ByVal Bob_m3m3 = -1, _
                    Optional ByVal Muob_cP = -1, _
                    Optional ByVal PVTcorr = StandingBased, _
                    Optional ByVal Ksep_fr = 0, _
                    Optional ByVal PKsep_atma = -1, _
                    Optional ByVal TKsep_C = -1, _
                    Optional ByVal PVTStr As String = "" _
                    ) As Double
' обязательные аргументы функции
' P_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед Rsb если Rp < Rsb
' Pb_atma   Давление насыщения при  температуре Tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' выходное значение - число - вязкость нефти
'           при заданных термобарических условиях, сП
On Error GoTo err1:
    Dim PVT As CPVT
    Set PVT = readPVT(gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Rp_m3m3, Pb_atma, Tres_C, Bob_m3m3, _
                    Muob_cP, PVTcorr, Ksep_fr, PKsep_atma, TKsep_C, PVTStr)
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(t_c))
    PVT_Muo_cP = PVT.Muo_cP
    Exit Function
err1:
    PVT_Muo_cP = "error"
    addLogMsg "error in function : PVT_Muo_cP"
End Function
' расчет вязкости газа
Public Function PVT_Mug_cP(P_atma, t_c, _
                    Optional ByVal gamma_gas As Double = const_gamma_gas_default, _
                    Optional ByVal gamma_oil As Double = const_gamma_oil_default, _
                    Optional ByVal gamma_wat As Double = const_gamma_wat_default, _
                    Optional ByVal rsb_m3m3 = const_Rsb_default, _
                    Optional ByVal Rp_m3m3 = -1, _
                    Optional ByVal Pb_atma = -1, _
                    Optional ByVal Tres_C = const_Tres_default, _
                    Optional ByVal Bob_m3m3 = -1, _
                    Optional ByVal Muob_cP = -1, _
                    Optional ByVal PVTcorr = StandingBased, _
                    Optional ByVal Ksep_fr = 0, _
                    Optional ByVal PKsep_atma = -1, _
                    Optional ByVal TKsep_C = -1, _
                    Optional ByVal PVTStr As String = "" _
                    ) As Double
' обязательные аргументы функции
' P_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед Rsb если Rp < Rsb
' Pb_atma   Давление насыщения при  температуре Tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' выходное значение - число - вязкость газа
'           при заданных термобарических условиях, сП
On Error GoTo err1:
    Dim PVT As CPVT
    Set PVT = readPVT(gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Rp_m3m3, Pb_atma, Tres_C, Bob_m3m3, _
                    Muob_cP, PVTcorr, Ksep_fr, PKsep_atma, TKsep_C, PVTStr)
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(t_c))
    PVT_Mug_cP = PVT.Mug_cP
    Exit Function
err1:
    PVT_Mug_cP = "error"
    addLogMsg "error in function : PVT_Mug_cP"
End Function
' расчет вязкости воды
Public Function PVT_Muw_cP(P_atma, t_c, _
                    Optional ByVal gamma_gas As Double = const_gamma_gas_default, _
                    Optional ByVal gamma_oil As Double = const_gamma_oil_default, _
                    Optional ByVal gamma_wat As Double = const_gamma_wat_default, _
                    Optional ByVal rsb_m3m3 = const_Rsb_default, _
                    Optional ByVal Rp_m3m3 = -1, _
                    Optional ByVal Pb_atma = -1, _
                    Optional ByVal Tres_C = const_Tres_default, _
                    Optional ByVal Bob_m3m3 = -1, _
                    Optional ByVal Muob_cP = -1, _
                    Optional ByVal PVTcorr = StandingBased, _
                    Optional ByVal Ksep_fr = 0, _
                    Optional ByVal PKsep_atma = -1, _
                    Optional ByVal TKsep_C = -1, _
                    Optional ByVal PVTStr As String = "" _
                    ) As Double
' обязательные аргументы функции
' P_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед Rsb если Rp < Rsb
' Pb_atma   Давление насыщения при  температуре Tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' выходное значение - число - вязкость воды
'           при заданных термобарических условиях, сП
On Error GoTo err1:
    Dim PVT As CPVT
    Set PVT = readPVT(gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Rp_m3m3, Pb_atma, Tres_C, Bob_m3m3, _
                    Muob_cP, PVTcorr, Ksep_fr, PKsep_atma, TKsep_C, PVTStr)
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(t_c))
    PVT_Muw_cP = PVT.Muw_cP
    Exit Function
err1:
    PVT_Muw_cP = "error"
    addLogMsg "error in function : PVT_Muw_cP"
End Function
' расчет газосодержания
Public Function PVT_Rs_m3m3(P_atma, t_c, _
                    Optional ByVal gamma_gas As Double = const_gamma_gas_default, _
                    Optional ByVal gamma_oil As Double = const_gamma_oil_default, _
                    Optional ByVal gamma_wat As Double = const_gamma_wat_default, _
                    Optional ByVal rsb_m3m3 = const_Rsb_default, _
                    Optional ByVal Rp_m3m3 = -1, _
                    Optional ByVal Pb_atma = -1, _
                    Optional ByVal Tres_C = const_Tres_default, _
                    Optional ByVal Bob_m3m3 = -1, _
                    Optional ByVal Muob_cP = -1, _
                    Optional ByVal PVTcorr = StandingBased, _
                    Optional ByVal Ksep_fr = 0, _
                    Optional ByVal PKsep_atma = -1, _
                    Optional ByVal TKsep_C = -1, _
                    Optional ByVal PVTStr As String = "" _
                    ) As Double
' обязательные аргументы функции
' P_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед Rsb если Rp < Rsb
' Pb_atma   Давление насыщения при  температуре Tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' выходное значение - число - газосодержание при
'           заданных термобарических условиях, м3/м3.
On Error GoTo err1:
    Dim PVT As CPVT
    Set PVT = readPVT(gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Rp_m3m3, Pb_atma, Tres_C, Bob_m3m3, _
                    Muob_cP, PVTcorr, Ksep_fr, PKsep_atma, TKsep_C, PVTStr)
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(t_c))
    PVT_Rs_m3m3 = PVT.rs_m3m3
    Exit Function
err1:
    PVT_Rs_m3m3 = "error"
    addLogMsg "error in function : PVT_Rs_m3m3"
End Function
' расчет коэффициента сверхсжимаемости газа
Public Function PVT_Z(P_atma, t_c, _
                    Optional ByVal gamma_gas As Double = const_gamma_gas_default, _
                    Optional ByVal gamma_oil As Double = const_gamma_oil_default, _
                    Optional ByVal gamma_wat As Double = const_gamma_wat_default, _
                    Optional ByVal rsb_m3m3 = const_Rsb_default, _
                    Optional ByVal Rp_m3m3 = -1, _
                    Optional ByVal Pb_atma = -1, _
                    Optional ByVal Tres_C = const_Tres_default, _
                    Optional ByVal Bob_m3m3 = -1, _
                    Optional ByVal Muob_cP = -1, _
                    Optional ByVal PVTcorr = StandingBased, _
                    Optional ByVal Ksep_fr = 0, _
                    Optional ByVal PKsep_atma = -1, _
                    Optional ByVal TKsep_C = -1, _
                    Optional ByVal PVTStr As String = "" _
                    ) As Double
' обязательные аргументы функции
' P_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед Rsb если Rp < Rsb
' Pb_atma   Давление насыщения при  температуре Tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' выходное значение - число - z фактор газа.
'           коэффициент сверхсжимаемости газа,
'           безразмерная величина
On Error GoTo err1:
    Dim PVT As CPVT
    Set PVT = readPVT(gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Rp_m3m3, Pb_atma, Tres_C, Bob_m3m3, _
                    Muob_cP, PVTcorr, Ksep_fr, PKsep_atma, TKsep_C, PVTStr)
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(t_c))
    PVT_Z = PVT.z
    Exit Function
err1:
    PVT_Z = "error"
    addLogMsg "error in function : PVT_Z"
End Function
' расчет плотности нефти
Public Function PVT_Rhoo_kgm3(P_atma, t_c, _
                    Optional ByVal gamma_gas As Double = const_gamma_gas_default, _
                    Optional ByVal gamma_oil As Double = const_gamma_oil_default, _
                    Optional ByVal gamma_wat As Double = const_gamma_wat_default, _
                    Optional ByVal rsb_m3m3 = const_Rsb_default, _
                    Optional ByVal Rp_m3m3 = -1, _
                    Optional ByVal Pb_atma = -1, _
                    Optional ByVal Tres_C = const_Tres_default, _
                    Optional ByVal Bob_m3m3 = -1, _
                    Optional ByVal Muob_cP = -1, _
                    Optional ByVal PVTcorr = StandingBased, _
                    Optional ByVal Ksep_fr = 0, _
                    Optional ByVal PKsep_atma = -1, _
                    Optional ByVal TKsep_C = -1, _
                    Optional ByVal PVTStr As String = "" _
                    ) As Double
' обязательные аргументы функции
' P_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед Rsb если Rp < Rsb
' Pb_atma   Давление насыщения при  температуре Tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' выходное значение - число - плотность нефти
'           при заданных термобарических условиях, кг/м3.
On Error GoTo err1:
    Dim PVT As CPVT
    Set PVT = readPVT(gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Rp_m3m3, Pb_atma, Tres_C, Bob_m3m3, _
                    Muob_cP, PVTcorr, Ksep_fr, PKsep_atma, TKsep_C, PVTStr)
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(t_c))
    PVT_Rhoo_kgm3 = PVT.rho_oil_kgm3
    Exit Function
err1:
    PVT_Rhoo_kgm3 = "error"
    addLogMsg "error in function : PVT_Rhoo_kgm3"
End Function
' расчет плотности газа
Public Function PVT_Rhog_kgm3(P_atma, t_c, _
                    Optional ByVal gamma_gas As Double = const_gamma_gas_default, _
                    Optional ByVal gamma_oil As Double = const_gamma_oil_default, _
                    Optional ByVal gamma_wat As Double = const_gamma_wat_default, _
                    Optional ByVal rsb_m3m3 = const_Rsb_default, _
                    Optional ByVal Rp_m3m3 = -1, _
                    Optional ByVal Pb_atma = -1, _
                    Optional ByVal Tres_C = const_Tres_default, _
                    Optional ByVal Bob_m3m3 = -1, _
                    Optional ByVal Muob_cP = -1, _
                    Optional ByVal PVTcorr = StandingBased, _
                    Optional ByVal Ksep_fr = 0, _
                    Optional ByVal PKsep_atma = -1, _
                    Optional ByVal TKsep_C = -1, _
                    Optional ByVal PVTStr As String = "" _
                    ) As Double
' обязательные аргументы функции
' P_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед Rsb если Rp < Rsb
' Pb_atma   Давление насыщения при  температуре Tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' выходное значение - число - плотность газа
'           при заданных термобарических условиях, кг/м3.
On Error GoTo err1:
    Dim PVT As CPVT
    Set PVT = readPVT(gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Rp_m3m3, Pb_atma, Tres_C, Bob_m3m3, _
                    Muob_cP, PVTcorr, Ksep_fr, PKsep_atma, TKsep_C, PVTStr)
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(t_c))
    PVT_Rhog_kgm3 = PVT.rho_gas_kgm3
    Exit Function
err1:
    PVT_Rhog_kgm3 = "error"
    addLogMsg "error in function : PVT_Rhog_kgm3"
End Function
' расчет плотности воды
Public Function PVT_Rhow_kgm3(P_atma, t_c, _
                    Optional ByVal gamma_gas As Double = const_gamma_gas_default, _
                    Optional ByVal gamma_oil As Double = const_gamma_oil_default, _
                    Optional ByVal gamma_wat As Double = const_gamma_wat_default, _
                    Optional ByVal rsb_m3m3 = const_Rsb_default, _
                    Optional ByVal Rp_m3m3 = -1, _
                    Optional ByVal Pb_atma = -1, _
                    Optional ByVal Tres_C = const_Tres_default, _
                    Optional ByVal Bob_m3m3 = -1, _
                    Optional ByVal Muob_cP = -1, _
                    Optional ByVal PVTcorr = StandingBased, _
                    Optional ByVal Ksep_fr = 0, _
                    Optional ByVal PKsep_atma = -1, _
                    Optional ByVal TKsep_C = -1, _
                    Optional ByVal PVTStr As String = "" _
                    ) As Double
' обязательные аргументы функции
' P_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед Rsb если Rp < Rsb
' Pb_atma   Давление насыщения при  температуре Tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' выходное значение - число - плотность воды
'           при заданных термобарических условиях, кг/м3.
On Error GoTo err1:
    Dim PVT As CPVT
    Set PVT = readPVT(gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Rp_m3m3, Pb_atma, Tres_C, Bob_m3m3, _
                    Muob_cP, PVTcorr, Ksep_fr, PKsep_atma, TKsep_C, PVTStr)
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(t_c))
    PVT_Rhow_kgm3 = PVT.rho_water_kgm3
    Exit Function
err1:
    PVT_Rhow_kgm3 = "error"
    addLogMsg "error in function : PVT_Rhow_kgm3"
End Function
' Расчет давления насыщения
Public Function PVT_Pb_atma(t_c, _
                    Optional ByVal gamma_gas As Double = const_gamma_gas_default, _
                    Optional ByVal gamma_oil As Double = const_gamma_oil_default, _
                    Optional ByVal gamma_wat As Double = const_gamma_wat_default, _
                    Optional ByVal rsb_m3m3 = const_Rsb_default, _
                    Optional ByVal Rp_m3m3 = -1, _
                    Optional ByVal Pb_atma = -1, _
                    Optional ByVal Tres_C = const_Tres_default, _
                    Optional ByVal Bob_m3m3 = -1, _
                    Optional ByVal Muob_cP = -1, _
                    Optional ByVal PVTcorr = StandingBased, _
                    Optional ByVal Ksep_fr = 0, _
                    Optional ByVal PKsep_atma = -1, _
                    Optional ByVal TKsep_C = -1, _
                    Optional ByVal PVTStr As String = "" _
                    ) As Double
' обязательные аргументы функции
' P_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед Rsb если Rp < Rsb
' Pb_atma   Давление насыщения при  температуре Tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' выходное значение - число - давление насыщения.
On Error GoTo err1:
    Dim PVT As CPVT
    Set PVT = readPVT(gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Rp_m3m3, Pb_atma, Tres_C, Bob_m3m3, _
                    Muob_cP, PVTcorr, Ksep_fr, PKsep_atma, TKsep_C, PVTStr)
    PVT_Pb_atma = PVT.Calc_Pb_atma(rsb_m3m3, t_c)
    Exit Function
err1:
    PVT_Pb_atma = "error"
    addLogMsg "error in function : PVT_Pb_atma"
End Function
' расчет коэффициента поверхностного натяжения нефть - газ
Public Function PVT_SToilgas_Nm(P_atma, t_c, _
                    Optional ByVal gamma_gas As Double = const_gamma_gas_default, _
                    Optional ByVal gamma_oil As Double = const_gamma_oil_default, _
                    Optional ByVal gamma_wat As Double = const_gamma_wat_default, _
                    Optional ByVal rsb_m3m3 = const_Rsb_default, _
                    Optional ByVal Rp_m3m3 = -1, _
                    Optional ByVal Pb_atma = -1, _
                    Optional ByVal Tres_C = const_Tres_default, _
                    Optional ByVal Bob_m3m3 = -1, _
                    Optional ByVal Muob_cP = -1, _
                    Optional ByVal PVTcorr = StandingBased, _
                    Optional ByVal Ksep_fr = 0, _
                    Optional ByVal PKsep_atma = -1, _
                    Optional ByVal TKsep_C = -1, _
                    Optional ByVal PVTStr As String = "" _
                    ) As Double
' обязательные аргументы функции
' P_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед Rsb если Rp < Rsb
' Pb_atma   Давление насыщения при  температуре Tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' выходное значение - число
' Возвращает коэффициента поверхностного натяжения нефть - газ, Нм
' для заданных термобарических условий.
On Error GoTo err1:
    Dim PVT As CPVT
    Set PVT = readPVT(gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Rp_m3m3, Pb_atma, Tres_C, Bob_m3m3, _
                    Muob_cP, PVTcorr, Ksep_fr, PKsep_atma, TKsep_C, PVTStr)
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(t_c))
    PVT_SToilgas_Nm = PVT.sigma_o_Nm
    Exit Function
err1:
    PVT_SToilgas_Nm = "error"
    addLogMsg "error in function : PVT_SToilgas_Nm"
End Function
' расчет коэффициента поверхностного натяжения вода - газ
Public Function PVT_STwatgas_Nm(P_atma, t_c, _
                    Optional ByVal gamma_gas As Double = const_gamma_gas_default, _
                    Optional ByVal gamma_oil As Double = const_gamma_oil_default, _
                    Optional ByVal gamma_wat As Double = const_gamma_wat_default, _
                    Optional ByVal rsb_m3m3 = const_Rsb_default, _
                    Optional ByVal Rp_m3m3 = -1, _
                    Optional ByVal Pb_atma = -1, _
                    Optional ByVal Tres_C = const_Tres_default, _
                    Optional ByVal Bob_m3m3 = -1, _
                    Optional ByVal Muob_cP = -1, _
                    Optional ByVal PVTcorr = StandingBased, _
                    Optional ByVal Ksep_fr = 0, _
                    Optional ByVal PKsep_atma = -1, _
                    Optional ByVal TKsep_C = -1, _
                    Optional ByVal PVTStr As String = "" _
                    ) As Double
' обязательные аргументы функции
' P_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед Rsb если Rp < Rsb
' Pb_atma   Давление насыщения при  температуре Tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' выходное значение - число
' Возвращает коэффициента поверхностного натяжения вода - газ, Нм
' для заданных термобарических условий.
On Error GoTo err1:
    Dim PVT As CPVT
    Set PVT = readPVT(gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Rp_m3m3, Pb_atma, Tres_C, Bob_m3m3, _
                    Muob_cP, PVTcorr, Ksep_fr, PKsep_atma, TKsep_C, PVTStr)
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(t_c))
    PVT_STwatgas_Nm = PVT.sigma_w_Nm
    Exit Function
err1:
    PVT_STwatgas_Nm = "error"
    addLogMsg "error in function : PVT_STwatgas_Nm"
End Function
' расчет коэффициента поверхностного натяжения жидкость - газ
Public Function PVT_STliqgas_Nm(P_atma, t_c, _
                    Optional ByVal gamma_gas As Double = const_gamma_gas_default, _
                    Optional ByVal gamma_oil As Double = const_gamma_oil_default, _
                    Optional ByVal gamma_wat As Double = const_gamma_wat_default, _
                    Optional ByVal rsb_m3m3 = const_Rsb_default, _
                    Optional ByVal Rp_m3m3 = -1, _
                    Optional ByVal Pb_atma = -1, _
                    Optional ByVal Tres_C = const_Tres_default, _
                    Optional ByVal Bob_m3m3 = -1, _
                    Optional ByVal Muob_cP = -1, _
                    Optional ByVal PVTcorr = StandingBased, _
                    Optional ByVal Ksep_fr = 0, _
                    Optional ByVal PKsep_atma = -1, _
                    Optional ByVal TKsep_C = -1, _
                    Optional ByVal PVTStr As String = "" _
                    ) As Double
' обязательные аргументы функции
' P_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед Rsb если Rp < Rsb
' Pb_atma   Давление насыщения при  температуре Tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' выходное значение - число
' Возвращает коэффициента поверхностного натяжения жидкость - газ, Нм
' для заданных термобарических условий.
On Error GoTo err1:
    Dim PVT As CPVT
    Set PVT = readPVT(gamma_gas, gamma_oil, gamma_wat, rsb_m3m3, Rp_m3m3, Pb_atma, Tres_C, Bob_m3m3, _
                    Muob_cP, PVTcorr, Ksep_fr, PKsep_atma, TKsep_C, PVTStr)
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(t_c))
    PVT_STliqgas_Nm = PVT.sigma_liq_Nm
    Exit Function
err1:
    PVT_STliqgas_Nm = "error"
    addLogMsg "error in function : PVT_STliqgas_Nm"
End Function
' ===================================================================================================================
'
' ===================================================================================================================
' функция расчета коэффициента Джоуля Томсона
Public Function MF_CJT_Katm(P_atma, t_c, _
                    Optional ByVal PVTStr As String = PVT_DEFAULT, _
                    Optional ByVal Ql_m3day As Double = 10, _
                    Optional ByVal fw_perc As Double = 0) As Double
' обязательные аргументы функции
' P_atma     давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
'
' PVTstr   encoded to string PVT properties of fluid
' Ql_m3day liquid rate (at surface)
' fw_perc  water fraction (watercut)
' output - number
On Error GoTo err1:
    Dim PVT As New CPVT
    Set PVT = PVT_Decode_string(PVTStr)
    PVT.Qliq_scm3day = Ql_m3day
    PVT.fw_perc = fw_perc
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(t_c))
    MF_CJT_Katm = PVT.CJT_Katm
    Exit Function
err1:
    MF_CJT_Katm = "error"
    addLogMsg "error in function : MF_CJT_Katm"
End Function
' расчет объемного расхода газожидкостной смеси для заданных термобарических условий
Public Function MF_Qmix_m3day(ByVal Qliq_m3day As Double, _
                              ByVal fw_perc As Double, _
                              ByVal P_atma As Double, _
                              ByVal t_c As Double, _
                              Optional ByVal PVTStr As String = "") As Double
' обязательные аргументы функции
' Qliq_m3day дебит жидкости на поверхности
' wc_perc   объемная обводненность
' P_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' PVTstr    encoded to string PVT properties of fluid
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' выходное значение - число - объемный расход ГЖС, м3/сут.
On Error GoTo err1:
    Dim PVT As CPVT
    Set PVT = PVT_Decode_string(PVTStr)
    PVT.fw_perc = fw_perc
    PVT.Qliq_scm3day = Qliq_m3day
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(t_c))
    MF_Qmix_m3day = PVT.Qmix_m3day
    Exit Function
err1:
    MF_Qmix_m3day = "error"
    addLogMsg "error in function : MF_Qmix_m3day"
End Function
' расчет плотности газожидкостной смеси для заданных  условий
Public Function MF_Rhomix_kgm3(ByVal Qliq_m3day As Double, _
                              ByVal fw_perc As Double, _
                              ByVal P_atma As Double, _
                              ByVal t_c As Double, _
                              Optional ByVal PVTStr As String = "") As Double
' обязательные аргументы функции
' Qliq_m3day дебит жидкости на поверхности
' wc_perc   объемная обводненность
' P_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' PVTstr    encoded to string PVT properties of fluid (use PVT_Encode_string to make PVTstr)
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' выходное значение - число - плотность ГЖС, кг/м3.
On Error GoTo err1:
    Dim PVT As CPVT
    Set PVT = PVT_Decode_string(PVTStr)
    PVT.fw_perc = fw_perc
    PVT.Qliq_scm3day = Qliq_m3day
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(t_c))
    MF_Rhomix_kgm3 = PVT.rho_mix_kgm3
    Exit Function
err1:
    MF_Rhomix_kgm3 = "error"
    addLogMsg "error in function : MF_Rhomix_kgm3"
End Function
' расчет вязкости газожидкостной смеси для заданных термобарических условий
Public Function MF_Mumix_cP(ByVal Qliq_m3day As Double, _
                              ByVal fw_perc As Double, _
                              ByVal P_atma As Double, _
                              ByVal t_c As Double, _
                              Optional ByVal PVTStr As String = "") As Double
' обязательные аргументы функции
' Qliq_m3day дебит жидкости на поверхности
' wc_perc   объемная обводненность
' P_atma    давление, атм
' Т_C       температура, С.
'
' опциональные аргументы функции
' PVTstr    encoded to string PVT properties of fluid (use PVT_Encode_string to make PVTstr)
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' выходное значение - число - вязкость ГЖС, м3/сут.
On Error GoTo err1:
    Dim PVT As CPVT
    Set PVT = PVT_Decode_string(PVTStr)
    PVT.fw_perc = fw_perc
    PVT.Qliq_scm3day = Qliq_m3day
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(t_c))
    MF_Mumix_cP = PVT.MuMix_cP
    Exit Function
err1:
    MF_Mumix_cP = "error"
    addLogMsg "error in function : MF_Mumix_cP"
End Function
' расчет доли газа в потоке
Public Function MF_GasFraction_d(P_atma, t_c, _
                    Optional ByVal fw_perc = 0, _
                    Optional ByVal PVTStr As String = "" _
                    ) As Double
' обязательные аргументы функции
' P_atma    давление, атм
' Т_C       температура, С.
' wc_perc   обводненность объемная
'
' опциональные аргументы функции
' gamma_gas удельная плотность газа, по воздуху.
'           const_gamma_gas_default = 0.6
' gamma_oil удельная плотность нефти, по воде.
'           const_gamma_oil_default = 0.86
' gamma_wat удельная плотность воды, по воде.
'           const_gamma_wat_default = 1
' Rsb_m3m3  газосодержание при давлении насыщения, м3/м3.
'           const_Rsb_default = 100
' Rp_m3m3   замерной газовый фактор, м3/м3.
'           имеет приоритет перед Rsb если Rp < Rsb
' Pb_atma   Давление насыщения при  температуре Tres_C, атма.
'           Опциональный калибровочный параметр,
'           если не задан или = 0 то рассчитается по корреляции
' Tres_C    пластовая температура, С.
'           Учитывается при расчете давления насыщения.
'           const_Tres_default = 90
' Bob_m3m3  объемный коэффициент нефти, м3/м3.
' Muob_cP   вязкость нефти при давлении насыщения
'           По умолчанию рассчитывается по корреляции
' PVTcorr   номер набора PVT корреляций для расчета
'           StandingBased = 0 - на основе кор-ии Стендинга
'           McCainBased = 1 - на основе кор-ии Маккейна
'           StraigthLine = 2 - на основе упрощенных зависимостей
' Ksep_fr   коэффициент сепарации - определяет изменение свойств
'           нефти после сепарации доли свободного газа.
'           изменение свойств нефти зависит от условий
'           сепарации газа, которые должны быть явно заданы
' PKsep_atma    давление при которой была сепарация
' TKsep_C       температура при которой была сепарация
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
'  выходное значение - число - доля газа в потоке
' (расходная без проскальзования)
On Error GoTo err1:
    Dim PVT As CPVT
    Set PVT = PVT_Decode_string(PVTStr)
    PVT.fw_perc = fw_perc
    Call PVT.Calc_PVT(CDbl(P_atma), CDbl(t_c))
    MF_GasFraction_d = PVT.GasFraction_d(0)
    Exit Function
err1:
    MF_GasFraction_d = "error"
    addLogMsg "error in function : MF_GasFraction_d"
End Function
' расчет давления при котором достигается заданная доля газа в потоке
Public Function MF_PGasFraction_atma(ByVal FreeGas_d As Double, _
                                     ByVal t_c As Double, _
                                     ByVal fw_perc As Double, _
                                     Optional ByVal PVTStr As String = PVT_DEFAULT) As Double
' обязательные аргументы функции
' FreeGas_d допустимая доля газа в потоке
' Т_C       температура, С.
' опциональные аргументы функции
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' выходное значение - число - давление, атма.
On Error GoTo err1:
    Dim PVT As CPVT
    Set PVT = PVT_Decode_string(PVTStr)
    PVT.fw_perc = fw_perc
    MF_PGasFraction_atma = PVT.PGasFraction_atma(FreeGas_d, t_c)
    Exit Function
err1:
    MF_PGasFraction_atma = "error"
    addLogMsg "error in function : MF_PGasFraction_atma"
End Function
' расчет газового фактора
' при котором достигается заданная доля газа в потоке
Public Function MF_RpGasFraction_m3m3(ByVal FreeGas_d As Double, _
                                     ByVal P_atma As Double, _
                                     ByVal t_c As Double, _
                                     ByVal fw_perc As Double, _
                                     Optional ByVal PVTStr As String = PVT_DEFAULT) As Double
' обязательные аргументы функции
' FreeGas_d допустимая доля газа в потоке
' P_atma     давление, атм
' Т_C       температура, С.
' опциональные аргументы функции
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
'
' выходное значение - число - газовый фактор, м3/м3.
On Error GoTo err1:
    Dim PVT As CPVT
    Set PVT = PVT_Decode_string(PVTStr)
    PVT.fw_perc = fw_perc
    MF_RpGasFraction_m3m3 = PVT.RpGasFraction_m3m3(FreeGas_d, P_atma, t_c)
    Exit Function
err1:
    MF_RpGasFraction_m3m3 = "error"
    addLogMsg "error in function : MF_RpGasFraction_m3m3"
End Function
' расчет натуральной сепарации газа на приеме насоса
Public Function MF_SeparNat_d(ByVal Pin_atma As Double, _
                              ByVal Qliq_m3day As Double, _
                                Optional ByVal fw_perc As Double = 0, _
                                Optional ByVal Tin_C As Double = 50, _
                                Optional ByVal dIntake_mm As Double = 90, _
                                Optional ByVal dCas_mm As Double = 120, _
                                Optional ByVal wc_perc = 0, _
                                Optional ByVal PVTStr As String = PVT_DEFAULT) As Double
'----------------------------------------------------------------
' Pin_atma       - давление сепарации
' Qliq_m3day    - дебит жидкости в поверхностных условиях
' fw_perc       - обводненность
' Tin_C         - температура сепарации
' dintake_mm    - диаметр приемной сетки
' dcas_mm       - диаметр эксплуатационной колонны
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
On Error GoTo err1:
    Dim Fluid As New CPVT
    Set Fluid = PVT_Decode_string(PVTStr)
    Fluid.Qliq_scm3day = Qliq_m3day
    Fluid.fw_perc = fw_perc
    Call Fluid.Calc_PVT(Pin_atma, Tin_C)
    With Fluid
        MF_SeparNat_d = unf_calc_natural_separation(dIntake_mm / 1000, dCas_mm / 1000, .Qliq_scm3day, .Qgas_scm3day, .Bo_m3m3, .Bg_m3m3, .sigma_o_Nm, .RhoOil_sckgm3, .rhoGas_sckgm3, .wc_perc)
    End With
    Exit Function
err1:
    MF_SeparNat_d = "error"
    addLogMsg "error in function :MF_SeparNat_d"
End Function
Public Function MF_SeparTotal_d(SepNat As Double, _
                                SepGasSep As Double) As Double
' SepNat        - естественная сепарация
' SepGasSep     - искусственная сепарация (газосепаратор)
    MF_SeparTotal_d = SepNat + (1 - SepNat) * SepGasSep
End Function
Public Function MF_PrGrad(ByVal d_m As Double, _
             ByVal P_atma As Double, _
             ByVal Ql_rc_m3day As Double, _
             ByVal Qg_rc_m3day As Double, _
            Optional ByVal Muo_cP As Double = const_mu_o, _
            Optional ByVal Mug_cP As Double = const_mu_g, _
            Optional ByVal sigma_o_Nm As Double = const_sigma_oil_Nm, _
            Optional ByVal gamma_oil As Double = const_gamma_oil_default, _
            Optional ByVal gamma_gas As Double = const_gamma_gas_default, _
            Optional ByVal eps_m As Double = 0.0001, _
            Optional ByVal theta_deg As Double = 90, _
            Optional ByVal ZNLF As Boolean = False)
' расчет градиента давления по одной из корреляций
' объемные коэффициенты по умолчанию заданы равными единицам - если их не трогать, значит дебиты в рабочих условиях
' газосодержание равно нулю по умолчанию - значит весь газ который указан идет в потоке
' пока только для Ансари - потом можно распространить и на другие методы
    Dim rho_osc_kgm3 As Double
    Dim rho_gsc_kgm3 As Double
    Dim dPdLg_out_atmm As Double
    Dim dPdLf_out_atmm As Double
    Dim Vsl_out_msec As Double
    Dim Vsg_out_msec As Double
    Dim Hl_out_fr As Double
    Dim fpat_out_num
    Dim dPdLa_out_atmm As Double
    Dim PrGrad
    
On Error GoTo er1:
    rho_osc_kgm3 = gamma_oil * const_rho_ref
    rho_gsc_kgm3 = gamma_gas * const_rho_air
    PrGrad = unf_AnsariGradient(d_m, theta_deg, eps_m, _
                                Ql_rc_m3day, Qg_rc_m3day, _
                                Muo_cP, Mug_cP, _
                                sigma_o_Nm, _
                                rho_osc_kgm3, _
                                rho_gsc_kgm3, _
                                P_atma)
    MF_PrGrad = PrGrad
    Exit Function
er1:
    MF_PrGrad = "error"
End Function
'  расчет перепада давления и распределения температуры в трубе
'  с использованием многофазных корреляций
Public Function MF_dPpipe_atm(ByVal Q_m3Day As Double, _
                                ByVal fw_perc As Double, _
                                ByVal Hmes0_m As Double, _
                                ByVal Hmes1_m As Double, _
                                ByVal Pcalc_atma As Double, _
                                Optional ByVal PVTStr As String = PVT_DEFAULT, _
                                Optional ByVal theta_deg As Double = 90, _
                                Optional ByVal d_mm As Double = 60, _
                                Optional ByVal HydrCorr As H_CORRELATION = 0, _
                                Optional ByVal Tcalc_C As Double = 50, _
                                Optional ByVal Tother_C As Double = -1, _
                                Optional ByVal betta_grav = 1, _
                                Optional ByVal betta_fric = 1, _
                                Optional ByVal roughness_m As Double = 0.0001)
'
' Обязательные параметры
' Q_m3Day       - дебит жидкости в поверхностных условиях
' fw_perc       - обводненность
' Hmes0_m       - начальная координата трубы, м
' Hmes1_m       - конечная координата трубы, м
'                 расчет всегда ведется от начальной координаты к
'                 конечной. если Hmes0_m < Hmes1_m то расчет
'                 идет сверху вниз для вертикальной трубы
'                 иначе расчет идет снизу вверх
' Pcalc_atma    - давление с которого начинается расчет, атм
'                 граничное значение для проведения расчета
' Необязательные параметры
' стандартные набор PVT параметров
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
' theta_deg     - угол направления потока к горизонтали
'                 (90 - вертикальная труба вверх)
'                 может принимать отрицательные значения
' d_mm          - внутрнний диаметр трубы
' HydrCorr      - гидравлическая корреляция, H_CORRELATION
'                   BeggsBriilCor = 0
'                   AnsariCor = 1
'                   UnifiedCor = 2
'                   Gray = 3
'                   HagedornBrown = 4
'                   SakharovMokhov = 5
' Tcalc_C       - температура в точке где задано давление, С
' Tother_C      - температура на другом конце трубы
'                 по умолчанию температура вдоль трубы постоянна
'                 если задано то меняется линейно по трубе
' betta_grav    - поправка на гравитационную составляющую перепада давления
' betta_fric    - поправка на трение в перепаде давления
' roughness_m   - шероховатость трубы
' выходное значение - число - перепад давления в трубе.
On Error GoTo err1:
    Dim dPT(2) As Double
    Dim PT
    PT = MF_Ppipe_atma(Q_m3Day, fw_perc, _
                Hmes0_m, Hmes1_m, _
                Pcalc_atma, _
                PVTStr, _
                theta_deg, _
                d_mm, _
                HydrCorr, _
                Tcalc_C, Tother_C, _
                betta_grav, betta_fric, _
                roughness_m)
    If Hmes0_m < Hmes1_m Then
        dPT(0) = PT(0) - Pcalc_atma
        dPT(1) = PT(1) - Tcalc_C
    Else
        dPT(0) = Pcalc_atma - PT(0)
        dPT(1) = Tcalc_C - PT(1)
    End If
    MF_dPpipe_atm = dPT
    Exit Function
err1:
    MF_dPpipe_atm = "error"
    addLogMsg "error in function : MF_dPpipe_atm"
End Function
'  расчет давления и распределения температуры в трубе
'  с использованием многофазных корреляций
Public Function MF_Ppipe_atma(ByVal Q_m3Day As Double, _
                                ByVal fw_perc As Double, _
                                ByVal Hmes0_m As Double, _
                                ByVal Hmes1_m As Double, _
                                ByVal Pcalc_atma As Double, _
                                Optional ByVal PVTStr As String = PVT_DEFAULT, _
                                Optional ByVal theta_deg As Double = 90, _
                                Optional ByVal d_mm As Double = 60, _
                                Optional ByVal HydrCorr As H_CORRELATION = 0, _
                                Optional ByVal Tcalc_C As Double = 50, _
                                Optional ByVal Tother_C As Double = -1, _
                                Optional ByVal betta_grav = 1, _
                                Optional ByVal betta_fric = 1, _
                                Optional ByVal roughness_m As Double = 0.0001)
'
' Обязательные параметры
' Q_m3Day       - дебит жидкости в поверхностных условиях
' fw_perc       - обводненность
' Hmes0_m       - начальная координата трубы, м
' Hmes1_m       - конечная координата трубы, м
'                 расчет всегда ведется от начальной координаты к
'                 конечной. если Hmes0_m < Hmes1_m то расчет
'                 идет сверху вниз для вертикальной трубы
'                 иначе расчет идет снизу вверх
' Pcalc_atma    - давление с которого начинается расчет, атм
'                 граничное значение для проведения расчета
' Необязательные параметры
' стандартные набор PVT параметров
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
' theta_deg     - угол направления потока к горизонтали
'                 (90 - вертикальная труба вверх)
'                 может принимать отрицательные значения
' d_mm          - внутрнний диаметр трубы
' HydrCorr      - гидравлическая корреляция, H_CORRELATION
'                   BeggsBriilCor = 0
'                   AnsariCor = 1
'                   UnifiedCor = 2
'                   Gray = 3
'                   HagedornBrown = 4
'                   SakharovMokhov = 5
' Tcalc_C       - температура в точке где задано давление, С
' Tother_C      - температура на другом конце трубы
'                 по умолчанию температура вдоль трубы постоянна
'                 если задано то меняется линейно по трубе
' betta_grav    - поправка на гравитационную составляющую перепада давления
' betta_fric    - поправка на трение в перепаде давления
' roughness_m   - шероховатость трубы
' выходное значение - число - давление на другом конце трубы atma.
On Error GoTo err1:
    ' first check trivial initial data
    If Hmes0_m = Hmes1_m Then
        MF_Ppipe_atma = Array(Pcalc_atma, Tcalc_C)
        Exit Function
    End If
    Dim pipe As New CPipe
    Dim PVT As New CPVT
    Dim PTcalc As PTtype
    Dim TM As TEMP_CALC_METHOD
    ' initialize PVT properties
    Set PVT = PVT_Decode_string(PVTStr)
    PVT.Qliq_scm3day = Q_m3Day
    PVT.fw_perc = fw_perc
    Set pipe.Fluid = PVT
    ' initialize boundary conditions
    PTcalc.P_atma = Pcalc_atma
    PTcalc.t_c = Tcalc_C
    If Tother_C < 0 Then Tother_C = Tcalc_C
    ' initialize geometry
    Call pipe.InitPipe(d_mm / 1000, Hmes0_m, Hmes1_m, theta_deg, roughness_m)
    If Hmes0_m < Hmes1_m Then
        pipe.Param = ParamCalcFromTop(HydrCorr, TempMeth:=StartEndTemp)
    Else
        pipe.Param = ParamCalcFromBottom(HydrCorr, TempMeth:=StartEndTemp)
    End If
    pipe.InitTlinear Tcalc_C, Tother_C
    pipe.betta_grav = betta_grav
    pipe.betta_fric = betta_fric
    ' calc pressure distribution
    MF_Ppipe_atma = ArrayOut(pipe.Calc_dPipe(PTcalc, noCurves))
    
    Exit Function
err1:
    'MF_Ppipe_atma = Array(Pcalc_atma, Tcalc_C)
    MF_Ppipe_atma = Array("error", "error")
    addLogMsg ("MF_Ppipe_atma: error")
End Function
'  расчет давления и распределения температуры в трубе
'  при барботаже (движение газа в затрубе при неподвижной жидкости)
'  с использованием многофазных корреляций
Public Function MF_PpipeZLNF_atma(ByVal Q_m3Day As Double, _
                                ByVal fw_perc As Double, _
                                ByVal Hmes0_m As Double, _
                                ByVal Hmes1_m As Double, _
                                ByVal Pcalc_atma As Double, _
                                Optional ByVal PVTStr As String = PVT_DEFAULT, _
                                Optional ByVal theta_deg As Double = 90, _
                                Optional ByVal d_mm As Double = 60, _
                                Optional ByVal HydrCorr As H_CORRELATION = 0, _
                                Optional ByVal Tcalc_C As Double = 50, _
                                Optional ByVal Tother_C As Double = -1, _
                                Optional ByVal betta_grav = 1, _
                                Optional ByVal betta_fric = 1, _
                                Optional ByVal roughness_m As Double = 0.0001, _
                                Optional ByVal Qgcas_free_scm3day As Double = 50)
'
' Обязательные параметры
' Q_m3Day       - дебит жидкости в поверхностных условиях (учтется при расчете газа в затрубе)
' fw_perc       - обводненность
' Hmes0_m       - начальная координата трубы, м
' Hmes1_m       - конечная координата трубы, м
'                 расчет всегда ведется от начальной координаты к
'                 конечной. если Hmes0_m < Hmes1_m то расчет
'                 идет сверху вниз для вертикальной трубы
'                 иначе расчет идет снизу вверх
' Pcalc_atma    - давление с которого начинается расчет, атм
'                 граничное значение для проведения расчета
' Необязательные параметры
' стандартные набор PVT параметров
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
' theta_deg     - угол направления потока к горизонтали
'                 (90 - вертикальная труба вверх)
'                 может принимать отрицательные значения
' d_mm          - внутрнний диаметр трубы
' HydrCorr      - гидравлическая корреляция, H_CORRELATION
'                   BeggsBriilCor = 0
'                   AnsariCor = 1
'                   UnifiedCor = 2
'                   Gray = 3
'                   HagedornBrown = 4
'                   SakharovMokhov = 5
'                 для барботажа принудительно на основе Ансари пока
' Tcalc_C       - температура в точке где задано давление, С
' Tother_C      - температура на другом конце трубы
'                 по умолчанию температура вдоль трубы постоянна
'                 если задано то меняется линейно по трубе
' betta_grav    - поправка на гравитационную составляющую перепада давления
' betta_fric    - поправка на трение в перепаде давления
' roughness_m   - шероховатость трубы
' Qgcas_free_scm3day    - количество газа в затрубе
' выходное значение - число - давление на другом конце трубы atma.
On Error GoTo err1:
    ' first check trivial initial data
    If Hmes0_m = Hmes1_m Then
        MF_PpipeZLNF_atma = Array(Pcalc_atma, Tcalc_C)
        Exit Function
    End If
    Dim pipe As New CPipe
    Dim PVT As New CPVT
    Dim PTcalc As PTtype
    Dim TM As TEMP_CALC_METHOD
    Dim Qg_free_scm3day As Double
    ' initialize PVT properties
    Set PVT = PVT_Decode_string(PVTStr)
    PVT.Qliq_scm3day = Q_m3Day
    PVT.fw_perc = fw_perc
    'Call PVT.Calc_PVT(PKsep_atma, TKsep_C)
   ' Qg_free_scm3day = PVT.QgasInSitu_scm3day ' свободный газ до сепарации
   'If Ksep_fr > 0 And Ksep_fr <= 1 And PKsep_atma > 0 And TKsep_C > 0 Then
    '    Call PVT.ModAfterSeparation(PKsep_atma, TKsep_C, Ksep_fr, GasGoesIntoSolution)
    PVT.Qgfree_scm3day = Qgcas_free_scm3day  ' оставляем газ только в затрубе который
    'End If
    Set pipe.Fluid = PVT
    ' initialize boundary conditions
    PTcalc.P_atma = Pcalc_atma
    PTcalc.t_c = Tcalc_C
    If Tother_C < 0 Then Tother_C = Tcalc_C
    ' initialize geometry
    Call pipe.InitPipe(d_mm / 1000, Hmes0_m, Hmes1_m, theta_deg, roughness_m)
    If Hmes0_m < Hmes1_m Then
        pipe.Param = ParamCalcFromTop(HydrCorr, TempMeth:=StartEndTemp)
    Else
        pipe.Param = ParamCalcFromBottom(HydrCorr, TempMeth:=StartEndTemp)
    End If
    pipe.InitTlinear Tcalc_C, Tother_C
    pipe.betta_grav = betta_grav
    pipe.betta_fric = betta_fric
    ' calc pressure distribution
    MF_PpipeZLNF_atma = ArrayOut(pipe.Calc_dPipeZNLF(PTcalc, noCurves))
    
    Exit Function
err1:
    MF_PpipeZLNF_atma = Array("error", "error")
    addLogMsg ("ошибка при расчете dPipe")
End Function
Private Function ArrayOut(PT As PTtype)
    ArrayOut = Array(PT.P_atma, PT.t_c)
End Function
' ==============  функции для расчета штуцера ==========================
' =====================================================================
'
' Расчет перепада давления в штуцере (по потоку)
' Расчет перепада давления в штуцере (по потоку)
Public Function MF_dPChoke_atm(dPipe_mm, dchoke_mm, _
            Pin_atma, Pout_atma, _
            Qliq_m3day, fw_perc, _
            Optional ByVal Tchoke_C As Double = 20, _
            Optional ByVal Calc_from_P0 As Boolean = True, _
            Optional ByVal PVTStr As String = PVT_DEFAULT)
            
On Error GoTo err1:
    Dim PT
    Dim dPT(2) As Double
    
    PT = MF_PChoke_atm(dPipe_mm, dchoke_mm, _
            Pin_atma, Pout_atma, _
            Qliq_m3day, fw_perc, _
            Tchoke_C, _
            Calc_from_P0, _
            PVTStr)
    If Calc_from_P0 Then
        dPT(0) = Pin_atma - PT(0)
    Else
        dPT(0) = PT(0) - Pout_atma
    End If
    dPT(1) = PT(1) - Tchoke_C
    
    MF_dPChoke_atm = dPT
    
    Exit Function
err1:
    MF_dPChoke_atm = "error"
    addLogMsg "error in function : MF_dPChoke_atm"
End Function
' расчет давления в штуцере
Public Function MF_PChoke_atm(ByVal dPipe_mm As Double, _
                                ByVal dchoke_mm As Double, _
                                ByVal Pin_atma As Double, _
                                ByVal Pout_atma As Double, _
                                ByVal Qliq_m3day As Double, _
                                ByVal fw_perc As Double, _
                                Optional ByVal Tchoke_C As Double = 20, _
                                Optional ByVal Calc_from_P0 As Boolean = True, _
                                Optional ByVal PVTStr As String = "")
' dPipe_mm      - диаметр трубы до и после штуцера
' dChoke_mm     - диаметр штуцера (эффективный)
' Pin_atma       - давление на входе (высокой стороне)
' Pout_atma       - давление на выходе (низкой стороне)
' Qliq_m3day    - дебит жидкости в пов условиях
' fw_perc      - обводненность
' опциональные аргументы функции
' Tchoke_C      - температура, С.
' Calc_from_P0 - показывает направление расчета штуцера
' PVTstr    закодированная строка с параметрами PVT.
'           если задана - перекрывает другие значения
' выходное значение - число - перепад давления на штуцере.
On Error GoTo err1:
    Dim Choke As New Cchoke
    Dim PT As PTtype
    Dim PVT As CPVT
    Set PVT = PVT_Encode_string(PVTStr)
    Set Choke.Fluid = PVT
    Choke.Fluid.Qliq_scm3day = Qliq_m3day
    Choke.Fluid.wc_perc = fw_perc
    Choke.Ddown_m = dPipe_mm / 1000
    Choke.Dup_m = dPipe_mm / 1000
    Choke.Dchoke_m = dchoke_mm / 1000
    If Calc_from_P0 Then
        PT = Choke.Calc_Choke_Plin(SetPT(Pin_atma, Tchoke_C))
    Else
        PT = Choke.Calc_Choke_Pbuf(SetPT(Pout_atma, Tchoke_C))
    End If
    MF_PChoke_atm = Array(PT.P_atma, PT.t_c)   ' на выходе выдаем массив
    Exit Function
err1:
    MF_PChoke_atm = "error"
    addLogMsg "error in function : MF_PChoke_atm"
End Function
 ' функция расчета дебита жидкости через штуцер
Public Function MF_QChoke_m3day(dPipe_mm, dchoke_mm, Pup_atma, Pdown_atma, fw_perc, _
                        Optional ByVal Tchoke_C = 20, _
                        Optional ByVal PVTStr As String = "")
' dPipe_mm      - диаметр трубы до и после штуцера
' dChoke_mm     - диаметр штуцера (эффективный)
' Pdown_atma     - давление на выходе (низкой стороне)
' Pup_atma       - давление на входе (высокой стороне)
' fw_perc      - обводненность
' данные PVT
On Error GoTo err1:
    Dim Choke As New Cchoke
    Dim PVT As CPVT
    Set PVT = PVT_Decode_string(PVTStr)
    Set Choke.Fluid = PVT
    Choke.Ddown_m = dPipe_mm / 1000
    Choke.Dup_m = dPipe_mm / 1000
    Choke.Dchoke_m = dchoke_mm / 1000
'    Choke.Fluid.Qliq_scm3day = Qliq_m3day
    Choke.Fluid.wc_perc = fw_perc
    MF_QChoke_m3day = Choke.Choke_liquid_rate(Pup_atma, Pdown_atma, Tchoke_C)
    Exit Function
err1:
    addLogMsg "QChoke_m3day: Расчет дебита через штуцер завершился с ошибкой Pup_atm=" & Pup_atma & " Pup_atma =" & Pdown_atma
    MF_QChoke_m3day = 0
End Function
' ==============  функции для расчета пласта ==========================
' =====================================================================
' расчет дебита по давлению и продуктивности
Public Function IPR_Ql_sm3Day(PI_m3dayatm, Pr_atma, Pwf_atma, _
        Optional ByVal fw_perc As Double = 0, Optional ByVal Pb_atma As Double = -1)
'
' PI_m3dayatm   - коэффициент продуктивности
' Pr_atma        - пластовое давление, атм
' Pwf_atma       - забойное давление
'
' необязательные параметры
' fw_perc      - обводненность
' Pb_atma        - давление насыщения
'
On Error GoTo err1:
    Dim res As New CReservoir
    If Pb_atma <= 0 Then Pb_atma = 0   ' поставим ноль иначе флюид додсчитает по корреляции значение
    res.InitProp Pr_atma, Pb_atma, fw_perc
    res.PI_m3dayatm = PI_m3dayatm
    
    IPR_Ql_sm3Day = res.Calc_Q_m3Day(Pwf_atma)
    Set res = Nothing
    
    
    Exit Function
err1:
    IPR_Ql_sm3Day = "error"
    addLogMsg "error in function : IPR_Ql_sm3Day"
End Function
' расчет дебита по давлению и продуктивности
Public Function IPR_Pwf_atma(PI_m3dayatm, Pr_atma, Ql_m3day, _
        Optional ByVal fw_perc As Double = 0, Optional ByVal Pb_atma As Double = -1)
'
' PI_m3dayatm   - коэффициент продуктивности
' Pr_atma        - пластовое давление, атм
' Ql_m3day      - дебит жидкости скважины на поверхности
'
' необязательные параметры
' fw_perc      - обводненность
' Pb_atma        - давление насыщения
'
On Error GoTo err1:
    Dim res As New CReservoir
    If Pb_atma <= 0 Then Pb_atma = 0   ' поставим ноль иначе флюид додсчитает по корреляции значение
    res.InitProp Pr_atma, Pb_atma, fw_perc
    res.PI_m3dayatm = PI_m3dayatm
    
    IPR_Pwf_atma = res.Calc_Pwf_atma(Ql_m3day)
    Set res = Nothing
    
    Exit Function
err1:
    IPR_Pwf_atma = "error"
    addLogMsg "error in function : IPR_Pwf_atma"
End Function
' расчет продуктивности
Public Function IPR_PI_sm3dayatm(Qtest_m3day, Pwftest_atma, Pr_atma, _
                Optional ByVal fw_perc As Double = 0, Optional ByVal Pb_atma As Double = -1)
'
' Qtest_m3day   - тестовый дебит скважины
' Pwftest_atma   - тестовое забойное давление
' Pr_atma        - пластовое давление, атм
'
' необязательные параметры
' fw_perc      - обводненность
' Pb_atma        - давление насыщения
'
On Error GoTo err1:
    Dim res As New CReservoir
    If Pb_atma <= 0 Then Pb_atma = 0   ' поставим ноль иначе флюид додсчитает по корреляции значение
    res.InitProp Pr_atma, Pb_atma, fw_perc
    On Error Resume Next
    IPR_PI_sm3dayatm = res.Calc_PI_m3DayAtm(Qtest_m3day, Pwftest_atma)
    Set res = Nothing
    
    Exit Function
err1:
    IPR_PI_sm3dayatm = "error"
    addLogMsg "error in function :IPR_PI_sm3dayatm"
End Function
